<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="http://openspace.ordnancesurvey.co.uk/osmapapi/openspace.js?key=CF171E7480B97DC0E0405F0AC86014BC"></script>  
  <script src="jquery-1.8.2.min.js"></script>
  
  <style type="text/css">
    .olControlScaleLine
    {
      margin-bottom: 30px;
	  font-size: 14px;
      font-family: Verdana, sans-serif;
	  background-color: #eee;
	  padding: 8px;
	  opacity: 0.8;
    }
    .olControlScaleLineTop
    {
	  font-size: 14px;
    }
    .olControlScaleLineBottom
    {
	  font-size: 14px;
    }
	
	#mapcontainer { margin-right: 320px; }
    #sidebar { width: 300px; float: right; }
	
	/*  style="height: 500px; width: auto; min-width: 500px;"  style="width: 300px; float: right;" */
  </style>
  
		
  
</head>
<body>
  <div id="sidebar">
	<div>To do: <span id="routeLenToDo"></span> km</div>
	<div>Done: <span id="routeLenCompl"></span> km</div>
  </div>
  <div id="mapcontainer">
    <div id="mapdiv"></div>
  </div>
<script>

	//map.removeLayer(defaultMarkerLayer);
	//var vlzi = defaultVectorLayer.getZIndex();
	//map.removeLayer(defaultVectorLayer);
    //var osmLayer = new OpenSpace.Layer.OSM();
    //map.addLayer(osmLayer);

    //console.log("default marker layer z index is " + defaultMarkerLayer.getZIndex());


		
	var lastUpdLbrt = [0,0,0,0];
	
    var zoom=0;
	
	var markerList = [];

	var size = new OpenLayers.Size(14, 20);
	var offset = new OpenLayers.Pixel(-7, -18);
	var infoWindowAnchor = new OpenLayers.Pixel(9, 18);
	function getWpIcon()
	{
		var iconUrl = "http://www.loughrigg.org/watershed/transpSP.png"
		//var iconUrl = "http://www.loughrigg.org/watershed/icon-signpost-27px.gif";
		//'http://openspace.ordnancesurvey.co.uk/osmapapi/img_versions/img_1.1/OS/images/markers/marker-target-sml-silver.png'
		var wpIcon = new OpenSpace.Icon(iconUrl, size, offset, null, infoWindowAnchor);
		return wpIcon;
	}
	

	
	//function handleZoomend()
	//{
	    //console.log("handleZoomend()");
	
	    //console.log("zoom: " + map.zoom);
	//}
	
	function handleMoveend()
	{
	    //console.log("handleMoveend()");	
	
	    if (map.zoom < 2)
		{
			map.clearMarkers();
			markerList = [];
		}
	
	    var oBnds = map.getExtent();
		var lbrt = oBnds.toArray();

		//console.log(lbrt[0]); //l
		//console.log(lbrt[1]); //b
		//console.log(lbrt[2]); //r
		//console.log(lbrt[3]); //t

		if (map.zoom > 3)
		{
			if ((Math.abs(lbrt[0] - lastUpdLbrt[0]) > 30000)
				|| (Math.abs(lbrt[1] - lastUpdLbrt[1]) > 30000)
				|| (Math.abs(lbrt[2] - lastUpdLbrt[2]) > 30000)
				|| (Math.abs(lbrt[3] - lastUpdLbrt[3]) > 30000))
			{
				var url = "markers.php?xl=" + (lbrt[0] - 30000) + "&xr=" + (lbrt[2] + 30000) +
								"&yb=" + (lbrt[1] - 30000) + "&yt=" + (lbrt[3] + 30000);
				$.ajax({
					url: url,
					dataType: 'json',
					success: markersCallback
				});
			
				lastUpdLbrt = lbrt;
			}
			defaultMarkerLayer.setVisibility(true);
		}
		else
		{
			defaultMarkerLayer.setVisibility(false);
		}

	}
	


	
	function replaceRoute(points, alreadyComplete)
    {
		//kill the existing route (removeFeatures()?)
		
		var lineString = new OpenLayers.Geometry.LineString(points); 

		var mapProj = map.getProjectionObject();
		console.log("getGeodesicLength: " + lineString.getGeodesicLength(mapProj));
		var dist = lineString.getGeodesicLength(mapProj) / 1000;
		if (true == alreadyComplete)
		{
			$("#routeLenCompl").text(dist);		
		}
		else
		{
			$("#routeLenToDo").text(dist);
		}
		
		var line_style = {strokeColor: "#AA0099", strokeOpacity: 1, strokeWidth: 3};
		if (true == alreadyComplete)
		{
			line_style = {strokeColor: "#33DD44", strokeOpacity: 1, strokeWidth: 3};
		}
		var lineFeature = new OpenLayers.Feature.Vector(lineString, null, line_style);
		defaultVectorLayer.addFeatures([lineFeature]); 
    }
	
	
	function addMarker(e, n, txt)
	{
		//console.log("addMarker " + e + ", " + n);
		for (m = 0; m < markerList.length; m++)
		{
			var cm = markerList[m];
			
			if ((cm.lonlat.lon == e) && (cm.lonlat.lat == n))
			{
				markerList.splice(m, 1);
				m --;
				map.removeMarker(cm);
				//console.log("removing marker cm with " + cm.lonlat.lon + ", " + cm.lonlat.lat);
			}
		}
		
		var pos = new OpenSpace.MapPoint(e, n);
		var m1 = map.createMarker(pos, getWpIcon(), txt);
		markerList.push(m1);
		//console.log("pushed marker " + e + ", " + n);	
	}
	
	
	
	function markersCallback(data)
    {
      var points = [];
      //console.log("markersCallback");
      for (p in data)
      {
	    if (!isNaN(data[p].E) && !isNaN(data[p].N))
		{
			//console.log("E " + route[p].E + ", N " + route[p].N + ", name " + route[p].Name + ", note " + route[p].Note);
			//var pt = addOScoordsToList(route[p].E, route[p].N);
			//pt = new OpenLayers.Geometry.Point(route[p].E, route[p].N); 
			//points.push(pt);

            var popupText = data[p].Name + "\r\n<br>\r\n" + data[p].Note;
            //var marker = new OpenLayers.Marker(pos);
            //markers.addMarker(marker);
			addMarker(data[p].E, data[p].N, popupText);
		}
      }
	}
	
	
	
	function recvCoordsDataCallback(data, alreadyComplete)
	{
        var points = [];
		var allCoords = data.split(";");
		for (var coordPair = 0; coordPair < allCoords.length; coordPair++)
		{
			if ("" != allCoords[coordPair])
			{
				var ca = allCoords[coordPair].split(",");
			
				var pt = new OpenLayers.Geometry.Point(ca[0], ca[1]); 
				points.push(pt);
			}
		}

        replaceRoute(points, alreadyComplete);
	}
	
	function recvCoordsDataCallbackCompl(data)
	{
	    recvCoordsDataCallback(data, true);
	}
	
	function recvCoordsDataCallbackToDo(data)
	{
	    recvCoordsDataCallback(data, false);
	}
	
	function resizeElementHeight(element)
	{
		var height = 0;
		var body = window.document.body;
		if (window.innerHeight)
		{
			height = window.innerHeight;
		}
			else if (body.parentElement.clientHeight)
		{
			height = body.parentElement.clientHeight;
		}
		else if (body && body.clientHeight)
		{
			height = body.clientHeight;
		}
		element.style.height = ((height - element.offsetTop) + "px");
	}
	
	
	var loadRoute = function(rdp)
	{
		$rdpSuffix = "";
		if (rdp > 0)
		{
			$rdpSuffix = "&rdp=" + rdp;"
		}
		$.ajax({
		  url: "coords.php?compl" + $rdpSuffix,
		  //dataType: 'txt',
		  //data: null,
		  success: recvCoordsDataCallbackCompl
		});
		
		$.ajax({
		  url: "coords.php?todo" + $rdpSuffix,
		  success: recvCoordsDataCallbackToDo
		});
	}
	
	var initMap = function()
	{
		//initialise globals - map, defaultMarkerLayer, defaultVectorLayer
		map = new OpenSpace.Map("mapdiv");
		defaultMarkerLayer = map.getMarkerLayer();
		defaultVectorLayer = map.getVectorLayer();
		defaultVectorLayer.setZIndex(100);
		map.addControl(new OpenLayers.Control.LayerSwitcher({'ascending':false}));
		map.setCenter(new OpenSpace.MapPoint(430000, 378000), zoom);

		var sl = new OpenLayers.Control.ScaleLine();
		sl.maxWidth = 160;
		map.addControl(sl);
	
		//map.events.register("zoomend", map, handleZoomend );
		map.events.register("moveend", map, handleMoveend );
	}
	
	var start = function()
	{
		resizeElementHeight($("#mapdiv")[0]);
		initMap();
		loadRoute(5000);
	}
	
	
	
	$(document).ready(start);
	
</script>


</body></html>